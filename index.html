<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Bank Game</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>⭐ Word Bank</h1>
      <p>Create 5-letter words from your daily bank</p>
    </div>

    <div class="current-word">
      <div class="word-slot" id="slot-0"></div>
      <div class="word-slot" id="slot-1"></div>
      <div class="word-slot" id="slot-2"></div>
      <div class="word-slot" id="slot-3"></div>
      <div class="word-slot" id="slot-4"></div>
    </div>

    <div class="letter-bank" id="letter-bank"></div>

    <div class="controls">
      <button class="btn" id="clear-btn" onclick="clearWord()">Clear</button>
      <button class="btn" id="back-btn" onclick="backspaceWord()">← Back</button>
      <button class="btn" id="submit-btn" onclick="submitWord()">Submit</button>
    </div>

    <div class="message" id="message"></div>
    <div class="found-words" id="found-words"></div>
    <div id="app-state">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading game...</p>
      </div>
    </div>
  </div>

  <script>
    const letterScores = {
      'A': 1, 'B': 2, 'C': 2, 'D': 2, 'E': 1, 'F': 2, 'G': 2, 'H': 2, 'I': 1, 'J': 4, 'K': 3,
      'L': 1, 'M': 2, 'N': 1, 'O': 1, 'P': 2, 'Q': 5, 'R': 1, 'S': 1, 'T': 1, 'U': 1, 'V': 3,
      'W': 2, 'X': 4, 'Y': 2, 'Z': 4
    };

    let gameState = {
      currentWord: '',
      selectedLetters: [],
      letterBank: [],
      originalDailyBankLetters: [],
      foundWords: [],
      validWords: [],
      totalScore: 0,
      gameFinished: false
    };

    let playerStats = {
      todaysGameCompleted: false,
      todaysGameData: null
    };

    let elements = {};

    function cacheElements() {
      elements = {
        letterBankContainer: document.getElementById('letter-bank'),
        slots: [
          document.getElementById('slot-0'),
          document.getElementById('slot-1'),
          document.getElementById('slot-2'),
          document.getElementById('slot-3'),
          document.getElementById('slot-4')
        ],
        clearBtn: document.getElementById('clear-btn'),
        backBtn: document.getElementById('back-btn'),
        submitBtn: document.getElementById('submit-btn'),
        message: document.getElementById('message'),
        foundWords: document.getElementById('found-words'),
        appState: document.getElementById('app-state')
      };
    }

    function loadStats() {
      const saved = localStorage.getItem('wordBankStats');
      if (saved) {
        playerStats = { ...playerStats, ...JSON.parse(saved) };
      }
    }

    function generateDailyBank() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const baseDate = new Date('2025-01-01');
      const daysSinceBase = Math.floor((today - baseDate) / (1000 * 60 * 60 * 24));

      function mulberry32(a) {
        return function () {
          let t = a += 0x6D2B79F5;
          t = Math.imul(t ^ t >>> 15, t | 1);
          t ^= t + Math.imul(t ^ t >>> 7, t | 61);
          return ((t ^ t >>> 14) >>> 0) / 4294969600;
        }
      }

      const rng = mulberry32(daysSinceBase);
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const bank = [];

      for (let i = 0; i < 12; i++) {
        const index = Math.floor(rng() * letters.length);
        bank.push(letters[index]);
      }

      return bank;
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function createLetterBank() {
      const layout = [5, 4, 3];
      let letterIndex = 0;
      elements.letterBankContainer.innerHTML = '';

      layout.forEach(count => {
        const row = document.createElement('div');
        row.className = 'pyramid-row';

        for (let i = 0; i < count; i++) {
          const letter = gameState.letterBank[letterIndex];
          const currentIndex = letterIndex;
          const button = document.createElement('button');
          button.className = 'letter-btn';
          button.id = `letter-btn-${currentIndex}`;
          button.dataset.index = currentIndex;
          button.innerHTML = `${letter}<div class="letter-value">${letterScores[letter] || 0}</div>`;
          button.onclick = () => selectLetter(letter, currentIndex);

          row.appendChild(button);
          letterIndex++;
        }

        elements.letterBankContainer.appendChild(row);
      });
    }

    function updateUI() {
      for (let i = 0; i < 5; i++) {
        const slot = elements.slots[i];
        slot.textContent = gameState.currentWord[i] || '';
      }

      document.querySelectorAll('.letter-btn').forEach(button => {
        const index = parseInt(button.dataset.index, 10);
        button.disabled = gameState.selectedLetters.includes(index);
      });

      elements.appState.style.display = 'none';
    }

    function selectLetter(letter, index) {
      if (gameState.currentWord.length >= 5 || gameState.selectedLetters.includes(index)) return;
      gameState.currentWord += letter;
      gameState.selectedLetters.push(index);
      updateUI();
    }

    function clearWord() {
      gameState.currentWord = '';
      gameState.selectedLetters = [];
      updateUI();
    }

    function backspaceWord() {
      gameState.currentWord = gameState.currentWord.slice(0, -1);
      gameState.selectedLetters.pop();
      updateUI();
    }

    function submitWord() {
      if (gameState.currentWord.length !== 5) {
        showMessage('Word must be 5 letters!');
        return;
      }
      if (!gameState.validWords.includes(gameState.currentWord)) {
        showMessage('Not a valid word!');
        clearWord();
        return;
      }
      if (gameState.foundWords.includes(gameState.currentWord)) {
        showMessage('Word already found!');
        clearWord();
        return;
      }

      gameState.foundWords.push(gameState.currentWord);
      gameState.totalScore += calculateWordScore(gameState.currentWord);
      showMessage(`+${calculateWordScore(gameState.currentWord)} pts`);
      clearWord();
    }

    function showMessage(text) {
      elements.message.textContent = text;
      setTimeout(() => {
        elements.message.textContent = '';
      }, 2000);
    }

    function calculateWordScore(word) {
      return word.split('').reduce((score, letter) => score + (letterScores[letter] || 0), 0);
    }

    function showCompletedGame() {
      if (!playerStats.todaysGameData) {
        console.warn("No saved data found. Starting fresh.");
        playerStats.todaysGameCompleted = false;
        initializeGame();
        return;
      }
      gameState.letterBank = shuffleArray([...gameState.originalDailyBankLetters]);
      gameState.foundWords = playerStats.todaysGameData.foundWords || [];
      gameState.totalScore = playerStats.todaysGameData.score || 0;
      gameState.gameFinished = true;
      createLetterBank();
      updateUI();
    }

    function initializeGame() {
      gameState.originalDailyBankLetters = generateDailyBank();
      gameState.letterBank = shuffleArray([...gameState.originalDailyBankLetters]);
      createLetterBank();
      updateUI();
    }

    async function loadWords() {
      try {
        const response = await fetch('./words.txt');
        const text = await response.text();
        gameState.validWords = text.split('\n').map(w => w.trim().toUpperCase()).filter(w => w.length === 5);

        gameState.originalDailyBankLetters = generateDailyBank();

        if (playerStats.todaysGameCompleted) {
          showCompletedGame();
        } else {
          initializeGame();
        }
      } catch (e) {
        elements.appState.innerHTML = '<p>Error loading word list.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM fully loaded. Starting initialization...');
      cacheElements();
      loadStats();
      loadWords();
    });
  </script>
</body>
</html>

